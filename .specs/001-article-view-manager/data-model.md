# Data Model: Sino Trade Article View Manager

**Phase**: 1 (Design & Contracts)
**Date**: 2025-11-05
**Purpose**: Define TypeScript interfaces and data structures for the application

## Overview

This application uses client-side state management with no backend persistence. All data models are TypeScript interfaces representing runtime state.

---

## Core Entities

### Article

Represents a Sino Trade article fetched from the GraphQL API.

```typescript
/**
 * Article entity from Sino Trade GraphQL API
 */
interface Article {
  /** MongoDB ObjectId from API */
  _id: string;

  /** Article title in Chinese (may contain special characters) */
  title: string;

  /** Computed article URL for view boosting */
  url?: string;
}
```

**Fields**:
- `_id`: Unique identifier from GraphQL response (e.g., `"68ff23fb032bb6011632bed5"`)
- `title`: Display name shown in dropdown (e.g., `"ÁæéËÇ°‰æùËàäÁ∫åÂâµÊñ∞È´òÔºåËÉåÂæåÁöÑÂ∫ïÊ∞£ÊòØ‰ªÄÈ∫º?"`)
- `url`: Optional computed field generated by `urlBuilder.ts` when article is selected

**Validation Rules**:
- `_id` must be 24-character hex string (MongoDB ObjectId format)
- `title` must not be empty
- `url` follows pattern: `https://www.sinotrade.com.tw/richclub/MacroExpert/{sanitized-title}--{_id}`

**Source**: GraphQL API response `data.clientGetArticleList.filtered[]`

---

### ArticleChannel

Represents a content category with associated GraphQL channel configuration.

```typescript
/**
 * Article channel configuration for GraphQL queries
 */
interface ArticleChannel {
  /** Internal channel identifier */
  id: 'macro-expert' | 'stock-talk';

  /** Display name in Chinese for tab label */
  label: 'Ê∑±Ë´áÁ∏ΩÁ∂ì' | 'ËÇ°Â∏ÇÁÜ±Ë©±';

  /** GraphQL channel ID for API query */
  channelId: string;

  /** Default visit count for this channel (FR-007) */
  defaultCount: number;

  /** Default visit interval in milliseconds (FR-008) */
  defaultInterval: number;
}
```

**Fields**:
- `id`: Internal enum for programmatic access
- `label`: User-facing tab label (Chinese)
- `channelId`: GraphQL query parameter (e.g., `"6514f8b3b13f2760605fcef1"`)
- `defaultCount`: Pre-filled value in form (200 for Ê∑±Ë´áÁ∏ΩÁ∂ì, 2000 for ËÇ°Â∏ÇÁÜ±Ë©±)
- `defaultInterval`: Pre-filled interval (300ms for both channels)

**Constants** (defined in `lib/constants.ts`):
```typescript
export const CHANNELS: Record<string, ArticleChannel> = {
  MACRO_EXPERT: {
    id: 'macro-expert',
    label: 'Ê∑±Ë´áÁ∏ΩÁ∂ì',
    channelId: '6514f8b3b13f2760605fcef1',
    defaultCount: 200,
    defaultInterval: 300
  },
  STOCK_TALK: {
    id: 'stock-talk',
    label: 'ËÇ°Â∏ÇÁÜ±Ë©±',
    channelId: '630c2850c6435a2ff402ccfb',
    defaultCount: 2000,
    defaultInterval: 300
  }
};
```

**Validation Rules**:
- `channelId` must match Sino Trade API channel IDs
- `defaultCount` between 1-10000 (per FR-005)
- `defaultInterval` minimum 300ms (per FR-006)

---

### BoostOperation

Represents the state and configuration of a view boost operation.

```typescript
/**
 * Boost operation state machine
 */
type BoostStatus = 'idle' | 'running' | 'paused' | 'completed' | 'error';

/**
 * Boost operation state and metrics
 */
interface BoostOperation {
  /** Current operation status */
  status: BoostStatus;

  /** Selected article being boosted */
  article: Article | null;

  /** Configuration */
  config: {
    /** Total number of requests to send */
    count: number;

    /** Interval between requests in milliseconds */
    interval: number;
  };

  /** Progress metrics */
  metrics: {
    /** Current request number (0-based index) */
    current: number;

    /** Successful requests (2xx responses) */
    success: number;

    /** Failed requests (errors, non-2xx) */
    failed: number;

    /** Array of response times in milliseconds */
    responseTimes: number[];

    /** Average response time in milliseconds */
    averageResponseTime: number;
  };

  /** Timing tracking */
  timing: {
    /** Operation start timestamp (ms since epoch) */
    startTime: number | null;

    /** Operation end timestamp (ms since epoch) */
    endTime: number | null;

    /** Total elapsed time in seconds (excluding paused time) */
    duration: number;

    /** Accumulated paused duration in milliseconds */
    pausedDuration: number;
  };

  /** Error state */
  error: string | null;
}
```

**State Machine Transitions**:
```
idle ‚Üí running   (user clicks "ÈñãÂßãÂü∑Ë°å")
running ‚Üí paused  (user clicks "Êö´ÂÅú")
paused ‚Üí running  (user clicks "ÁπºÁ∫å")
running ‚Üí completed (all requests finished)
running ‚Üí error   (critical failure, e.g., network down)
paused ‚Üí idle     (user clicks "ÈáçÊñ∞ÈñãÂßã")
completed ‚Üí idle  (user clicks "ÈáçÊñ∞ÈñãÂßã")
error ‚Üí idle      (user clicks "ÈáçÊñ∞ÈñãÂßã")
```

**Validation Rules**:
- `config.count`: 1-10000 (per FR-005)
- `config.interval`: ‚â•300ms (per FR-006)
- `metrics.current`: 0 ‚â§ current ‚â§ config.count
- `metrics.success + metrics.failed`: ‚â§ config.count
- `metrics.averageResponseTime`: calculated as `sum(responseTimes) / responseTimes.length`
- `timing.duration`: `(endTime || Date.now()) - startTime - pausedDuration` in seconds

**Initialization** (when status = 'idle'):
```typescript
const initialState: BoostOperation = {
  status: 'idle',
  article: null,
  config: { count: 200, interval: 300 },
  metrics: { current: 0, success: 0, failed: 0, responseTimes: [], averageResponseTime: 0 },
  timing: { startTime: null, endTime: null, duration: 0, pausedDuration: 0 },
  error: null
};
```

---

### ActivityLogEntry

Represents a timestamped event in the boost operation activity log.

```typescript
/**
 * Activity log entry type
 */
type LogType = 'info' | 'success' | 'error';

/**
 * Activity log entry for operation timeline
 */
interface ActivityLogEntry {
  /** Unique entry ID (timestamp + random) */
  id: string;

  /** Entry timestamp (ms since epoch) */
  timestamp: number;

  /** Log level / type */
  type: LogType;

  /** Human-readable message in Chinese */
  message: string;

  /** Optional associated data (e.g., HTTP status code) */
  metadata?: Record<string, unknown>;
}
```

**Fields**:
- `id`: Unique identifier for React key (e.g., `${Date.now()}-${Math.random()}`)
- `timestamp`: Used for display formatting (`new Date(timestamp).toLocaleTimeString('zh-TW')`)
- `type`: Determines visual styling (color, icon)
- `message`: User-facing message (e.g., `"Ë´ãÊ±Ç 10/200 - ÁãÄÊÖã: 200 (350ms)"`)
- `metadata`: Optional structured data for debugging (not displayed to user)

**Example Entries**:
```typescript
// Operation start
{ id: '...', timestamp: 1699200000000, type: 'info',
  message: 'üöÄ ÈñãÂßãÂü∑Ë°åËôïÁêÜ' }

// Progress update (every 10 requests per FR-012)
{ id: '...', timestamp: 1699200003500, type: 'success',
  message: 'Ë´ãÊ±Ç 10/200 - ÁãÄÊÖã: 200 (350ms)',
  metadata: { status: 200, responseTime: 350 } }

// Error
{ id: '...', timestamp: 1699200005000, type: 'error',
  message: 'Ë´ãÊ±Ç 15/200 - ÁãÄÊÖã: 500 (1200ms)',
  metadata: { status: 500, responseTime: 1200 } }

// Completion
{ id: '...', timestamp: 1699200060000, type: 'success',
  message: '‚úÖ ÂÆåÊàêÔºÅÊàêÂäü: 198/200 (Âü∑Ë°åÊôÇÈñì: 60Áßí)',
  metadata: { success: 198, total: 200, duration: 60 } }
```

**Validation Rules**:
- `message` must not be empty
- `timestamp` must be valid Unix timestamp
- Activity log limited to 50 most recent entries (FIFO eviction)

---

## Computed/Derived Data

### Article URL Construction

Article URLs are computed on-demand when an article is selected, using the `urlBuilder` utility.

**Algorithm** (from requirements/enable-search.md):
```typescript
function buildArticleUrl(article: Article): string {
  // 1. Sanitize title: replace special chars with hyphens
  const sanitized = article.title
    .replace(/[,Ôºå\s\?Ôºü]/g, '-')  // Replace comma, space, question marks
    .replace(/-+/g, '-')            // Collapse multiple hyphens
    .replace(/^-|-$/g, '');         // Trim leading/trailing hyphens

  // 2. Construct URL with double-dash separator before ID
  return `https://www.sinotrade.com.tw/richclub/MacroExpert/${sanitized}--${article._id}`;
}
```

**Example**:
```typescript
Input:  { _id: "68e4a15046b10f98ffe2f4bc",
          title: "‰∏çÁïèÊîøÂ∫úÈóúÈñÄÔºåÁæéËÇ°‰æùËàäÁ∫åÂâµÊñ∞È´òÔºåËÉåÂæåÁöÑÂ∫ïÊ∞£ÊòØ‰ªÄÈ∫º? ÁæéËÇ°ÁöÑÁãÇÊ≠°ÈÇÑËÉΩÊåÅÁ∫åÂ§ö‰πÖÔºü" }

Output: "https://www.sinotrade.com.tw/richclub/MacroExpert/‰∏çÁïèÊîøÂ∫úÈóúÈñÄ-ÁæéËÇ°‰æùËàäÁ∫åÂâµÊñ∞È´ò-ËÉåÂæåÁöÑÂ∫ïÊ∞£ÊòØ‰ªÄÈ∫º--ÁæéËÇ°ÁöÑÁãÇÊ≠°ÈÇÑËÉΩÊåÅÁ∫åÂ§ö‰πÖ--68e4a15046b10f98ffe2f4bc"
```

**Validation**:
- URL must end with `--{24-char-hex-id}`
- Chinese characters preserved (URL encoding handled by browser)
- Special characters replaced per requirements

---

### Progress Percentage

Progress percentage is computed from current request count vs total count.

```typescript
function calculateProgress(current: number, total: number): number {
  if (total === 0) return 0;
  return Math.round((current / total) * 100);
}
```

**Range**: 0-100 (integer percentage)

---

### Average Response Time

Average response time computed from `responseTimes` array.

```typescript
function calculateAverageResponseTime(responseTimes: number[]): number {
  if (responseTimes.length === 0) return 0;
  const sum = responseTimes.reduce((acc, time) => acc + time, 0);
  return Math.round(sum / responseTimes.length);
}
```

**Unit**: Milliseconds (integer)
**Display**: `{avg}ms` (e.g., "350ms")

---

## State Management Strategy

### Hook-Based State Management

Primary state managed via `useBoostOperation` custom hook with `useReducer`:

```typescript
// hooks/useBoostOperation.ts
type Action =
  | { type: 'START'; payload: { article: Article; count: number; interval: number } }
  | { type: 'PAUSE' }
  | { type: 'RESUME' }
  | { type: 'RESET' }
  | { type: 'UPDATE_PROGRESS'; payload: { success: boolean; responseTime: number } }
  | { type: 'COMPLETE' }
  | { type: 'ERROR'; payload: string };

function boostReducer(state: BoostOperation, action: Action): BoostOperation {
  switch (action.type) {
    case 'START':
      return {
        ...state,
        status: 'running',
        article: action.payload.article,
        config: { count: action.payload.count, interval: action.payload.interval },
        timing: { ...state.timing, startTime: Date.now() },
        error: null
      };
    // ... other cases
  }
}

export function useBoostOperation() {
  const [state, dispatch] = useReducer(boostReducer, initialState);

  const start = (article: Article, count: number, interval: number) =>
    dispatch({ type: 'START', payload: { article, count, interval } });

  const pause = () => dispatch({ type: 'PAUSE' });
  const resume = () => dispatch({ type: 'RESUME' });
  const reset = () => dispatch({ type: 'RESET' });

  return { state, actions: { start, pause, resume, reset } };
}
```

### Component State Ownership

| State | Owner | Reason |
|-------|-------|--------|
| Selected channel | `TabSelector` | Local to tab component, passed to parent via callback |
| Article list | `useArticles` hook | Shared between `ArticleSelector` and parent page |
| Selected article | `ArticleSelector` | Local dropdown state, passed to parent via callback |
| Boost operation | `useBoostOperation` hook | Shared between `BoostControls` and `ProgressMonitor` |
| Activity log | `ProgressMonitor` | Local to progress component, populated via operation events |
| Form inputs | `BoostControls` | Local form state, validated on submit |

---

## Type Exports

All types exported from `lib/types.ts` for app-wide usage:

```typescript
// lib/types.ts
export type { Article, ArticleChannel, BoostOperation, BoostStatus, ActivityLogEntry, LogType };
```

---

## Validation Summary

| Entity | Required Validations |
|--------|---------------------|
| **Article** | `_id` is 24-char hex, `title` non-empty |
| **ArticleChannel** | `defaultCount` 1-10000, `defaultInterval` ‚â•300ms |
| **BoostOperation** | `config.count` 1-10000, `config.interval` ‚â•300ms, state transitions valid |
| **ActivityLogEntry** | `message` non-empty, `timestamp` valid, log size ‚â§50 entries |
| **Article URL** | Ends with `--{24-char-hex-id}`, special chars sanitized |

All validations implemented in respective service/utility files with TypeScript type guards and runtime checks.
